---
- name: Configure XOS multicast network interfaces
  hosts: all
  become: true
  gather_facts: true

  vars:
    interface_mgmt: "bond-mgmt"
    interface_mc_in_p:    "ens3f0"
    interface_mc_in_s:    "ens4f0"
    interface_mc_out_p:   "ens3f1"
    interface_mc_out_s:   "ens4f1"

    subnet_mc_in_p:    "10.25.1.0/24"
    subnet_mc_in_s:    "10.25.4.0/24"
    subnet_mc_out_p:   "10.25.3.0/24"
    subnet_mc_out_s:   "10.25.5.0/24"

    mc_connections:
      - name: "MC_IN_P"
        interface: "{{ interface_mc_in_p }}"
        subnet: "{{ subnet_mc_in_p }}"
      - name: "MC_IN_S"
        interface: "{{ interface_mc_in_s }}"
        subnet: "{{ subnet_mc_in_s }}"
      - name: "MC_OUT_P"
        interface: "{{ interface_mc_out_p }}"
        subnet: "{{ subnet_mc_out_p }}"
      - name: "MC_OUT_S"
        interface: "{{ interface_mc_out_s }}"
        subnet: "{{ subnet_mc_out_s }}"

  tasks:
    # --------------------------
    # Precondition checks
    # --------------------------
    - name: Check if management interface exists
      command: ip link show {{ interface_mgmt }}
      register: mgmt_interface_check
      changed_when: false
      failed_when: false

    - name: Fail if management interface is not available
      fail:
        msg: "Management interface {{ interface_mgmt }} is not available."
      when: mgmt_interface_check.rc != 0

    - name: Get management interface IP configuration
      command: "nmcli -t -f IP4.ADDRESS,GENERAL.STATE device show {{ interface_mgmt }}"
      register: mgmt_ip_config
      changed_when: false
      failed_when: false

    - name: Extract management interface IP address
      set_fact:
        mgmt_ip_address: >-
          {{
            (mgmt_ip_config.stdout_lines | default([])
            | select('match', '^IP4\\.ADDRESS.*:.*/') | list | length > 0)
            | ternary(
                (mgmt_ip_config.stdout_lines | default([])
                | select('match', '^IP4\\.ADDRESS.*:.*/') | list | first
                | regex_replace('^IP4\\.ADDRESS(\\[\\d+\\])?:', '') | regex_replace('/.*', '')),
                ''
              )
          }}

    - name: Check if management interface is connected
      set_fact:
        mgmt_connected: "{{ 'GENERAL.STATE:100 (connected)' in mgmt_ip_config.stdout }}"

    - name: Fail if management interface has no IP or is not connected
      fail:
        msg: >-
          Management interface {{ interface_mgmt }} has no IP address or is not connected.
          IP: {{ mgmt_ip_address }}, Connected: {{ mgmt_connected }}
      when: (mgmt_ip_address == "") or (not mgmt_connected | bool)

    - name: Extract last octet of management interface IP
      set_fact:
        last_octet: "{{ mgmt_ip_address.split('.')[-1] }}"

    - name: Debug extracted last octet
      debug:
        msg: "Last octet of management interface IP is {{ last_octet }}"

    - name: Extract subnet base addresses (remove /24 suffix)
      set_fact:
        subnet_mc_in_p_base: "{{ subnet_mc_in_p | regex_replace('/24$', '') | regex_replace('\\.0$', '') }}"
        subnet_mc_in_s_base: "{{ subnet_mc_in_s | regex_replace('/24$', '') | regex_replace('\\.0$', '') }}"
        subnet_mc_out_p_base: "{{ subnet_mc_out_p | regex_replace('/24$', '') | regex_replace('\\.0$', '') }}"
        subnet_mc_out_s_base: "{{ subnet_mc_out_s | regex_replace('/24$', '') | regex_replace('\\.0$', '') }}"

    - name: Check if multicast interfaces are available
      command: ip link show {{ item.interface }}
      register: mc_interface_checks
      loop: "{{ mc_connections }}"
      changed_when: false
      failed_when: false

    - name: Fail if any multicast interface is not available
      fail:
        msg: >-
          Multicast interface(s) not available:
          {{ mc_interface_checks.results | selectattr('rc', 'ne', 0) | map(attribute='item.interface') | list }}
      when: mc_interface_checks.results | selectattr('rc', 'ne', 0) | list | length > 0

    # --------------------------
    # Cleanup orphaned connections
    # --------------------------
    - name: Get all NetworkManager connections
      command: "nmcli -t -f NAME con show"
      register: all_connections
      changed_when: false

    - name: Get connections with device mapping
      command: "nmcli -t -f NAME,DEVICE con show"
      register: connections_with_devices
      changed_when: false

    - name: Debug all connections before cleanup
      debug:
        var: all_connections.stdout_lines

    - name: Find connections with no device (orphaned)
      set_fact:
        connections_no_device: >-
          {{
            connections_with_devices.stdout_lines | default([])
            | select('match', '^([^:]+):$') | map('regex_replace', '^([^:]+):$', '\\1') | list
          }}

    - name: Find connections matching orphaned patterns
      set_fact:
        connections_matching_patterns: >-
          {{
            all_connections.stdout_lines | default([])
            | select('match', '^(Wired connection|MC_|ens[0-9]|eth[0-9])') | list
          }}

    - name: Combine orphaned connections (no device + matching patterns, exclude current MC connections)
      set_fact:
        connections_to_delete: >-
          {{
            ((connections_no_device | default([])) + (connections_matching_patterns | default([])))
            | difference(mc_connections | map(attribute='name') | list)
            | unique | list
          }}

    - name: Debug connections to delete
      debug:
        msg: "Found {{ connections_to_delete | length }} orphaned connections to delete: {{ connections_to_delete }}"
      when: connections_to_delete | length > 0

    - name: Bring down orphaned connections before deletion
      command: "nmcli con down '{{ item }}'"
      loop: "{{ connections_to_delete }}"
      failed_when: false
      changed_when: false
      when: connections_to_delete | length > 0

    - name: Delete orphaned connections
      command: "nmcli con delete '{{ item }}'"
      loop: "{{ connections_to_delete }}"
      failed_when: false
      register: delete_orphans
      when: connections_to_delete | length > 0

    - name: Debug deletion results
      debug:
        msg:
          - "Attempted to delete {{ connections_to_delete | length }} connections"
          - "Connections: {{ connections_to_delete }}"
      when: (connections_to_delete | length > 0) and (delete_orphans.results is defined)

    # --------------------------
    # Configure multicast interfaces (idempotent)
    # --------------------------
    - name: Check which multicast connections already exist
      command: "nmcli -t -f NAME con show"
      register: existing_mc_connections
      changed_when: false

    - name: Set existence flags for multicast connections
      set_fact:
        mc_connections_exist: >-
          {{
            mc_connections | map(attribute='name') | map('string')
            | select('in', existing_mc_connections.stdout_lines) | list
          }}

    - name: Debug multicast connection existence
      debug:
        msg:
          - "Existing MC connections: {{ mc_connections_exist }}"
          - "Connections to create: {{ mc_connections | map(attribute='name') | list | difference(mc_connections_exist) }}"

    - name: Create multicast connections if missing
      command: >
        nmcli con add type ethernet
        ifname {{ item.interface }}
        con-name {{ item.name }}
        ipv6.method disabled
        connection.autoconnect yes
      loop: "{{ mc_connections }}"
      when: item.name not in mc_connections_exist
      register: create_mc_connections

    - name: Configure multicast connection IP addresses
      command: >
        nmcli con mod {{ item.name }}
        ipv4.addresses "{{ item.subnet | regex_replace('/24$', '') | regex_replace('\\.0$', '') }}.{{ last_octet }}/24"
        ipv4.method manual
        ipv6.method disabled
        connection.autoconnect yes
      loop: "{{ mc_connections }}"
      register: configure_mc_ips

    - name: Reload NetworkManager connections
      command: nmcli con reload
      changed_when: false

    - name: Bring up multicast connections
      command: "nmcli con up {{ item.name }}"
      loop: "{{ mc_connections }}"
      register: bring_up_mc
      failed_when: false

    - name: Wait for multicast interfaces to obtain IP addresses
      command: "nmcli -g IP4.ADDRESS dev show {{ item.interface }}"
      loop: "{{ mc_connections }}"
      register: mc_ip_checks
      retries: 5
      delay: 2
      until: mc_ip_checks.stdout is search('.+/.+')
      failed_when: false

    - name: Debug multicast interface IPs after bring-up
      debug:
        msg: "{{ item.item.name }} ({{ item.item.interface }}): {{ item.stdout | default('No IP assigned') }}"
      loop: "{{ mc_ip_checks.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Get final connection status
      command: "nmcli -t -f NAME,DEVICE,IP4.ADDRESS con show"
      register: final_connections
      changed_when: false

    - name: Debug final multicast connections
      debug:
        msg: "{{ final_connections.stdout_lines | select('search', '^MC_') | list }}"
