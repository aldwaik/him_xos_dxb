---
- name: Configure XOS multicast network interfaces
  hosts: all
  become: yes
  vars:
    interface_mgmt: "bond-mgmt"
    # Interface names will be auto-detected based on available interfaces
    interface_mc_in_p: ""
    interface_mc_in_s: ""
    interface_mc_out_p: ""
    interface_mc_out_s: ""

    subnet_mc_in_p:    "10.25.1.0/24"
    subnet_mc_in_s:    "10.25.4.0/24"
    subnet_mc_out_p:   "10.25.3.0/24"
    subnet_mc_out_s:   "10.25.5.0/24"

    last_octet: ""

  tasks:
    - name: Check if management interface is available
      command: ip link show {{ item }}
      register: result
      failed_when: result.rc != 0
      with_items:
        - "{{ interface_mgmt }}"
      ignore_errors: yes

    - name: Fail if any interface is not available
      fail:
        msg: "Management interface is not available."
      when: result.results | selectattr('rc', 'ne', 0) | list | length > 0

    # --------------------------
    # Auto-detect multicast interface pattern
    # --------------------------
    - name: Check for interface pattern 1 (ens3f0/ens4f0/ens3f1/ens4f1)
      command: ip link show {{ item }}
      register: pattern1_check
      loop:
        - "ens3f0"
        - "ens4f0"
        - "ens3f1"
        - "ens4f1"
      changed_when: false
      failed_when: false

    - name: Check for interface pattern 2 (ens2f0/ens5f0/ens2f1/ens5f1)
      command: ip link show {{ item }}
      register: pattern2_check
      loop:
        - "ens2f0"
        - "ens5f0"
        - "ens2f1"
        - "ens5f1"
      changed_when: false
      failed_when: false

    - name: Determine which pattern exists
      set_fact:
        pattern1_exists: >-
          {{
            pattern1_check.results | selectattr('rc', 'equalto', 0) | list | length == 4
          }}
        pattern2_exists: >-
          {{
            pattern2_check.results | selectattr('rc', 'equalto', 0) | list | length == 4
          }}

    - name: Set multicast interfaces for pattern 1
      set_fact:
        interface_mc_in_p: "ens3f0"
        interface_mc_in_s: "ens4f0"
        interface_mc_out_p: "ens3f1"
        interface_mc_out_s: "ens4f1"
      when: pattern1_exists | bool

    - name: Set multicast interfaces for pattern 2
      set_fact:
        interface_mc_in_p: "ens2f0"
        interface_mc_in_s: "ens5f0"
        interface_mc_out_p: "ens2f1"
        interface_mc_out_s: "ens5f1"
      when: pattern2_exists | bool

    - name: Fail if no multicast interface pattern detected
      fail:
        msg: >-
          No valid multicast interface pattern detected.
          Pattern 1 (ens3f0/ens4f0/ens3f1/ens4f1) exists: {{ pattern1_exists | default(false) }}
          Pattern 2 (ens2f0/ens5f0/ens2f1/ens5f1) exists: {{ pattern2_exists | default(false) }}
      when: (not pattern1_exists | default(false) | bool) and (not pattern2_exists | default(false) | bool)

    - name: Debug detected multicast interfaces
      debug:
        msg:
          - "Detected multicast interfaces:"
          - "  MC_IN_P:  {{ interface_mc_in_p }}"
          - "  MC_IN_S:  {{ interface_mc_in_s }}"
          - "  MC_OUT_P: {{ interface_mc_out_p }}"
          - "  MC_OUT_S: {{ interface_mc_out_s }}"

    - name: Check IP configuration of management interface
      command: nmcli -t -f IP4.ADDRESS,GENERAL.STATE device show {{ interface_mgmt }}
      register: mgmt_ip_config

    - name: Fail if management interface has no IP or is not UP
      fail:
        msg: "Management interface {{ interface_mgmt }} has no IP address or is not UP."
      when: mgmt_ip_config.stdout | regex_search('IP4.ADDRESS[^\n]*') is not defined or mgmt_ip_config.stdout.find('GENERAL.STATE:100 (connected)') == -1

    - name: Extract last octet of management interface IP
      set_fact:
        last_octet: "{{ mgmt_ip_config.stdout | regex_search('IP4.ADDRESS[^\n]*') | regex_replace('.*\\.', '') | regex_replace('/.*', '') }}"

    - name: Print last octet
      debug:
        msg: "Last octet of management interface IP is {{ last_octet }}"

    - name: Set encoder subnets
      set_fact:
        subnet_mc_in_p: "{{ subnet_mc_in_p | regex_replace('.0/.*', '') }}"
        subnet_mc_in_s: "{{ subnet_mc_in_s | regex_replace('.0/.*', '') }}"
        subnet_mc_out_p: "{{ subnet_mc_out_p | regex_replace('.0/.*', '') }}"
        subnet_mc_out_s: "{{ subnet_mc_out_s | regex_replace('.0/.*', '') }}"

    - name: Check if multicast interfaces are available
      command: ip link show {{ item }}
      register: result_mc
      failed_when: result_mc.rc != 0
      with_items:
        - "{{ interface_mc_in_p }}"
        - "{{ interface_mc_in_s }}"
        - "{{ interface_mc_out_p }}"
        - "{{ interface_mc_out_s }}"
      ignore_errors: yes

    - name: Fail if multicast interface/s not available
      fail:
        msg: "Multicast interface/s not available."
      when: result_mc.results | selectattr('rc', 'ne', 0) | list | length > 0

    - name: Fail if encoder subnets are not set
      fail:
        msg: "Encoder subnets are not set."
      when: subnet_mc_in_p is not defined or subnet_mc_in_s is not defined or subnet_mc_out_p is not defined or subnet_mc_out_s is not defined

    - name: Delete old connections
      shell: |
        nmcli -t -f NAME,DEVICE con show | awk -F: '$2 == "" {print $1}' | xargs -I {} nmcli con delete "{}"
        nmcli -t -f NAME con show | grep -E "^Wired connection" | xargs -I {} nmcli con delete "{}"
        nmcli -t -f NAME con show | grep -E "^MC_" | xargs -I {} nmcli con delete "{}"
        nmcli -t -f NAME con show | grep -E "^ens" | xargs -I {} nmcli con delete "{}"
        nmcli -t -f NAME con show | grep -E "^eth" | xargs -I {} nmcli con delete "{}"
      register: deleted_connections
      ignore_errors: yes
      failed_when: false

    - name: Debug the deleted connections
      debug:
        msg: "Deleted connections: {{ deleted_connections.stdout_lines }}"

    - name: Configure Multicast Interfaces
      shell: |
        nmcli con add type ethernet ifname {{ interface_mc_in_p }} con-name MC_IN_P
        nmcli con add type ethernet ifname {{ interface_mc_in_s }} con-name MC_IN_S
        nmcli con add type ethernet ifname {{ interface_mc_out_p }} con-name MC_OUT_P
        nmcli con add type ethernet ifname {{ interface_mc_out_s }} con-name MC_OUT_S
        nmcli con mod MC_IN_P  ipv4.addresses {{ subnet_mc_in_p }}.{{ last_octet }}/24  ipv4.method manual ipv6.method disabled
        nmcli con mod MC_IN_S  ipv4.addresses {{ subnet_mc_in_s }}.{{ last_octet }}/24  ipv4.method manual ipv6.method disabled
        nmcli con mod MC_OUT_P ipv4.addresses {{ subnet_mc_out_p }}.{{ last_octet }}/24 ipv4.method manual ipv6.method disabled
        nmcli con mod MC_OUT_S ipv4.addresses {{ subnet_mc_out_s }}.{{ last_octet }}/24 ipv4.method manual ipv6.method disabled
      register: created_connections

    - name: Debug the Created connections
      debug:
        msg: "Created connections: {{ created_connections.stdout_lines }}"

    - name: Reload NetworkManager connections
      command: nmcli con reload
      changed_when: false

    - name: Bring up multicast interfaces
      command: "nmcli con up {{ item }}"
      loop:
        - "MC_IN_P"
        - "MC_IN_S"
        - "MC_OUT_P"
        - "MC_OUT_S"
      register: bring_up_results
      failed_when: false
