#version=RHEL9
# Rocky Linux 9 Kickstart Configuration
# Compatible with Rocky 9.x

# System authorization information
authselect select sssd --force

# Use graphical install
graphical

# Use UEFI boot with GPT partitioning
zerombr
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=600 --fsoptions="umask=0077,shortname=winnt"
part / --fstype=xfs --grow --size=1

# Network configuration - DHCP on first available interface
network --bootproto=dhcp --device=link --activate
# Bonded configuration (uncomment to use instead of DHCP)
# network --device=bond0 --noipv6 --bootproto=dhcp --bondslaves=eno1,eno2 --bondopts=mode=active-backup,miimon=100,updelay=100,primary=eno1 --activate

%pre
echo 'GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"' >> /etc/default/grub

# Detect NIC names with "UP" status (exclude bond and specific NICs)
NIC1=$(ip link show | awk '/state UP/ {print $2}' | sed 's/://g' | grep -v 'bond' | grep -v 'lo' | sort | head -n 1)
NIC2=$(ip link show | awk '/state UP/ {print $2}' | sed 's/://g' | grep -v 'bond' | grep -v 'lo' | sort | head -n 2 | tail -n 1)

# Optional: Uncomment to use bonded configuration in pre-script
# if [ -n "$NIC1" ] && [ -n "$NIC2" ]; then
#   network --device=bond0 --noipv6 --bootproto=dhcp --bondslaves=$NIC1,$NIC2 --bondopts=mode=active-backup,miimon=100,updelay=100,primary=$NIC1 --activate
# fi

%end

# Root password
rootpw --plaintext "rootpass"

# Create engineer user
user --name=engineer --password="engineerpass" --plaintext --gecos="Engineer User"

# Timezone
timezone Asia/Riyadh --utc

# Keyboard layout
keyboard --vckeymap=us --xlayouts='us'

# Language
lang en_US.UTF-8

# Disable firewall and SELinux
firewall --disabled
selinux --disabled

# Installation source
url --url="http://10.15.13.188:16000/eiso/id/2"

# Packages to install
%packages
@^minimal-environment
@standard
net-tools
zip
unzip
ftp
wget
git
xauth
xterm
yum-utils
dnf-utils
nfs-utils
tcpdump
chrony
rsyslog
python3
curl
%end

%post
# Minimal chroot post script: ensure grub is configured and record a basic marker
exec > /root/ks-post.log 2>&1 || true
echo "chroot post started: $(date)" >> /root/ks-post.log
grub2-mkconfig -o /boot/efi/EFI/rocky/grub.cfg || grub2-mkconfig -o /boot/grub2/grub.cfg || true
echo "chroot post completed: $(date)" >> /root/ks-post.log
%end

# Post-install script executed outside chroot (operates on /mnt/sysimage)
%post --nochroot
exec > /mnt/sysimage/root/ks-post.log 2>&1 || true
echo "nochroot post started: $(date)" >> /mnt/sysimage/root/ks-post.log

# Create sudoers file in installed system (ensure password is required)
mkdir -p /mnt/sysimage/etc/sudoers.d
cat > /mnt/sysimage/etc/sudoers.d/engineer << 'EOE'
# Engineer user with password requirement
engineer ALL=(ALL) ALL
EOE
chmod 0440 /mnt/sysimage/etc/sudoers.d/engineer
echo "created /etc/sudoers.d/engineer" >> /mnt/sysimage/root/ks-post.log

# Add Docker CE repository and install Docker inside the installed system (chroot)
if chroot /mnt/sysimage dnf --version >/dev/null 2>&1; then
	chroot /mnt/sysimage /bin/bash -c 'dnf config-manager --add-repo=https://download.docker.com/linux/rhel/docker-ce.repo || true'
	chroot /mnt/sysimage /bin/bash -c 'dnf install -y docker-ce docker-ce-cli containerd.io || true'
	# Try to enable the docker service; if systemctl fails inside chroot, ignore
	chroot /mnt/sysimage /bin/bash -c 'systemctl enable docker || true'
	echo "docker install attempted" >> /mnt/sysimage/root/ks-post.log
else
	echo "dnf not available in installed system; skipping docker install" >> /mnt/sysimage/root/ks-post.log
fi

# Enable root SSH password login (explicitly configure sshd in installed system)
if [ -f /mnt/sysimage/etc/ssh/sshd_config ]; then
	# Comment out or remove any existing PermitRootLogin and PasswordAuthentication lines, then add our own
	sed -i 's/^PermitRootLogin/#&/; s/^#PermitRootLogin yes/PermitRootLogin yes/' /mnt/sysimage/etc/ssh/sshd_config || true
	sed -i 's/^PasswordAuthentication/#&/; s/^#PasswordAuthentication yes/PasswordAuthentication yes/' /mnt/sysimage/etc/ssh/sshd_config || true
	
	# Add the settings if they don't exist
	grep -q 'PermitRootLogin yes' /mnt/sysimage/etc/ssh/sshd_config || echo 'PermitRootLogin yes' >> /mnt/sysimage/etc/ssh/sshd_config
	grep -q 'PasswordAuthentication yes' /mnt/sysimage/etc/ssh/sshd_config || echo 'PasswordAuthentication yes' >> /mnt/sysimage/etc/ssh/sshd_config
	
	echo "PermitRootLogin and PasswordAuthentication configured" >> /mnt/sysimage/root/ks-post.log
	chroot /mnt/sysimage /bin/bash -c 'systemctl enable sshd || true'
	
	# Verify the changes
	echo "--- sshd_config verification ---" >> /mnt/sysimage/root/ks-post.log
	grep -E 'PermitRootLogin|PasswordAuthentication' /mnt/sysimage/etc/ssh/sshd_config >> /mnt/sysimage/root/ks-post.log 2>&1 || echo "grep failed" >> /mnt/sysimage/root/ks-post.log
else
	echo "/etc/ssh/sshd_config not found; skipping ssh config" >> /mnt/sysimage/root/ks-post.log
fi

echo "nochroot post completed: $(date)" >> /mnt/sysimage/root/ks-post.log
%end

# Reboot after installation
reboot
