#version=RHEL9
# Rocky Linux 9 Kickstart Configuration
# Compatible with Rocky 9.x

# System authorization information
authselect select sssd --force

# Use graphical install
graphical

# Use UEFI boot with GPT partitioning
zerombr
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=600 --fsoptions="umask=0077,shortname=winnt"
part / --fstype=xfs --grow --size=1

# Network configuration - DHCP on first available interface
network --bootproto=dhcp --device=link --activate
# Bonded configuration (uncomment to use instead of DHCP)
# network --device=bond0 --noipv6 --bootproto=dhcp --bondslaves=eno1,eno2 --bondopts=mode=active-backup,miimon=100,updelay=100,primary=eno1 --activate

%pre
echo 'GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"' >> /etc/default/grub

# Detect NIC names with "UP" status (exclude bond and specific NICs)
NIC1=$(ip link show | awk '/state UP/ {print $2}' | sed 's/://g' | grep -v 'bond' | grep -v 'lo' | sort | head -n 1)
NIC2=$(ip link show | awk '/state UP/ {print $2}' | sed 's/://g' | grep -v 'bond' | grep -v 'lo' | sort | head -n 2 | tail -n 1)

# Optional: Uncomment to use bonded configuration in pre-script
# if [ -n "$NIC1" ] && [ -n "$NIC2" ]; then
#   network --device=bond0 --noipv6 --bootproto=dhcp --bondslaves=$NIC1,$NIC2 --bondopts=mode=active-backup,miimon=100,updelay=100,primary=$NIC1 --activate
# fi

%end

# Root password
rootpw --plaintext "rootpass"

# Create engineer user
user --name=engineer --password="engineerpass" --plaintext --gecos="Engineer User"

# Timezone
timezone Asia/Riyadh --utc

# Keyboard layout
keyboard --vckeymap=us --xlayouts='us'

# Language
lang en_US.UTF-8

# Disable firewall and SELinux
firewall --disabled
selinux --disabled

# Installation source
url --url="http://10.15.13.188:16000/eiso/id/1"

# Packages to install
%packages
@^minimal-environment
@standard
net-tools
zip
unzip
ftp
wget
git
xauth
xterm
yum-utils
dnf-utils
nfs-utils
tcpdump
chrony
rsyslog
python3
curl
%end

# Post-installation script (in chroot)
%post

# Redirect output to a log file
exec > /root/ks-post.log 2>&1

# Rebuild GRUB with kernel parameters
grub2-mkconfig -o /boot/efi/EFI/rocky/grub.cfg || grub2-mkconfig -o /boot/grub2/grub.cfg

# Add Docker CE repository (Rocky-compatible)
dnf config-manager --add-repo=https://download.docker.com/linux/rhel/docker-ce.repo

# Install Docker packages
dnf install -y docker-ce docker-ce-cli containerd.io

# Enable and start Docker service
systemctl enable docker
systemctl start docker

# Configure sudoers for engineer user (requires password entry)
echo "# Engineer user with password requirement" > /etc/sudoers.d/engineer
echo "engineer ALL=(ALL) ALL" >> /etc/sudoers.d/engineer
chmod 0440 /etc/sudoers.d/engineer

# Verify Docker installation
docker --version >> /root/ks-post.log 2>&1
%end

# Reboot after installation
reboot
